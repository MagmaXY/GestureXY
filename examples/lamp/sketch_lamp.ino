//#include <ESP8266WiFi.h>
#include <WiFi.h>
#include <PubSubClient.h>
#include "SettingsGyver.h"
#include "GyverDBFile.h"
#include "LittleFS.h"
#include <FastLED.h>
#include <EncButton.h>

#include "GestureXY.h"
#include "ParsingXY.h"

#define WIDTH 8     // —à–∏—Ä–∏–Ω–∞ –º–∞—Ç—Ä–∏—Ü—ã
#define HEIGHT 8    // –≤—ã—Å–æ—Ç–∞ –º–∞—Ç—Ä–∏—Ü—ã
#define SEGMENTS 1  // –¥–∏–æ–¥–æ–≤ –≤ –æ–¥–Ω–æ–º "–ø–∏–∫—Å–µ–ª–µ" (–¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –º–∞—Ç—Ä–∏—Ü—ã –∏–∑ –∫—É—Å–∫–æ–≤ –ª–µ–Ω—Ç—ã)
#define NUM WIDTH* HEIGHT

#define MATRIX_TYPE 1       // —Ç–∏–ø –º–∞—Ç—Ä–∏—Ü—ã: 0 - –∑–∏–≥–∑–∞–≥, 1 - –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è
#define CONNECTION_ANGLE 3  // —É–≥–æ–ª –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: 0 - –ª–µ–≤—ã–π –Ω–∏–∂–Ω–∏–π, 1 - –ª–µ–≤—ã–π –≤–µ—Ä—Ö–Ω–∏–π, 2 - –ø—Ä–∞–≤—ã–π –≤–µ—Ä—Ö–Ω–∏–π, 3 - –ø—Ä–∞–≤—ã–π –Ω–∏–∂–Ω–∏–π
#define STRIP_DIRECTION 2   // –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ª–µ–Ω—Ç—ã –∏–∑ —É–≥–ª–∞: 0 - –≤–ø—Ä–∞–≤–æ, 1 - –≤–≤–µ—Ä—Ö, 2 - –≤–ª–µ–≤–æ, 3 - –≤–Ω–∏–∑

// **************** –ù–ê–°–¢–†–û–ô–ö–ò ****************
#define TEXT_DIRECTION 1  // 1 - –ø–æ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª–∏, 0 - –ø–æ –≤–µ—Ä—Ç–∏–∫–∞–ª–∏
#define MIRR_V 0          // –æ—Ç—Ä–∞–∑–∏—Ç—å —Ç–µ–∫—Å—Ç –ø–æ –≤–µ—Ä—Ç–∏–∫–∞–ª–∏ (0 / 1)
#define MIRR_H 0          // –æ—Ç—Ä–∞–∑–∏—Ç—å —Ç–µ–∫—Å—Ç –ø–æ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª–∏ (0 / 1)

#define TEXT_HEIGHT 0  // –≤—ã—Å–æ—Ç–∞, –Ω–∞ –∫–æ—Ç–æ—Ä–æ–π –±–µ–∂–∏—Ç —Ç–µ–∫—Å—Ç (–æ—Ç –Ω–∏–∑–∞ –º–∞—Ç—Ä–∏—Ü—ã)
#define LET_WIDTH 5    // —à–∏—Ä–∏–Ω–∞ –±—É–∫–≤—ã —à—Ä–∏—Ñ—Ç–∞
#define LET_HEIGHT 8   // –≤—ã—Å–æ—Ç–∞ –±—É–∫–≤—ã —à—Ä–∏—Ñ—Ç–∞
#define SPACE 1        // –ø—Ä–æ–±–µ–ª
#define D_TEXT_SPEED 100

const uint8_t fontHEX[][5] PROGMEM = {
  { 0x00, 0x00, 0x00, 0x00, 0x00 },  //   0x20 32
  { 0x00, 0x00, 0x6f, 0x00, 0x00 },  // ! 0x21 33
  { 0x00, 0x07, 0x00, 0x07, 0x00 },  // " 0x22 34
  { 0x14, 0x7f, 0x14, 0x7f, 0x14 },  // # 0x23 35
  { 0x00, 0x07, 0x04, 0x1e, 0x00 },  // $ 0x24 36
  { 0x23, 0x13, 0x08, 0x64, 0x62 },  // % 0x25 37
  { 0x36, 0x49, 0x56, 0x20, 0x50 },  // & 0x26 38
  { 0x00, 0x00, 0x07, 0x00, 0x00 },  // ' 0x27 39
  { 0x00, 0x1c, 0x22, 0x41, 0x00 },  // ( 0x28 40
  { 0x00, 0x41, 0x22, 0x1c, 0x00 },  // ) 0x29 41
  { 0x14, 0x08, 0x3e, 0x08, 0x14 },  // * 0x2a 42
  { 0x08, 0x08, 0x3e, 0x08, 0x08 },  // + 0x2b 43
  { 0x00, 0x50, 0x30, 0x00, 0x00 },  // , 0x2c 44
  { 0x08, 0x08, 0x08, 0x08, 0x08 },  // - 0x2d 45
  { 0x00, 0x60, 0x60, 0x00, 0x00 },  // . 0x2e 46
  { 0x20, 0x10, 0x08, 0x04, 0x02 },  // / 0x2f 47
  { 0x3e, 0x51, 0x49, 0x45, 0x3e },  // 0 0x30 48
  { 0x00, 0x42, 0x7f, 0x40, 0x00 },  // 1 0x31 49
  { 0x42, 0x61, 0x51, 0x49, 0x46 },  // 2 0x32 50
  { 0x21, 0x41, 0x45, 0x4b, 0x31 },  // 3 0x33 51
  { 0x18, 0x14, 0x12, 0x7f, 0x10 },  // 4 0x34 52
  { 0x27, 0x45, 0x45, 0x45, 0x39 },  // 5 0x35 53
  { 0x3c, 0x4a, 0x49, 0x49, 0x30 },  // 6 0x36 54
  { 0x01, 0x71, 0x09, 0x05, 0x03 },  // 7 0x37 55
  { 0x36, 0x49, 0x49, 0x49, 0x36 },  // 8 0x38 56
  { 0x06, 0x49, 0x49, 0x29, 0x1e },  // 9 0x39 57
  { 0x00, 0x36, 0x36, 0x00, 0x00 },  // : 0x3a 58
  { 0x00, 0x56, 0x36, 0x00, 0x00 },  // ; 0x3b 59
  { 0x08, 0x14, 0x22, 0x41, 0x00 },  // < 0x3c 60
  { 0x14, 0x14, 0x14, 0x14, 0x14 },  // = 0x3d 61
  { 0x00, 0x41, 0x22, 0x14, 0x08 },  // > 0x3e 62
  { 0x02, 0x01, 0x51, 0x09, 0x06 },  // ? 0x3f 63
  { 0x3e, 0x41, 0x5d, 0x49, 0x4e },  // @ 0x40 64
  { 0x7e, 0x09, 0x09, 0x09, 0x7e },  // A 0x41 65
  { 0x7f, 0x49, 0x49, 0x49, 0x36 },  // B 0x42 66
  { 0x3e, 0x41, 0x41, 0x41, 0x22 },  // C 0x43 67
  { 0x7f, 0x41, 0x41, 0x41, 0x3e },  // D 0x44 68
  { 0x7f, 0x49, 0x49, 0x49, 0x41 },  // E 0x45 69
  { 0x7f, 0x09, 0x09, 0x09, 0x01 },  // F 0x46 70
  { 0x3e, 0x41, 0x49, 0x49, 0x7a },  // G 0x47 71
  { 0x7f, 0x08, 0x08, 0x08, 0x7f },  // H 0x48 72
  { 0x00, 0x41, 0x7f, 0x41, 0x00 },  // I 0x49 73
  { 0x20, 0x40, 0x41, 0x3f, 0x01 },  // J 0x4a 74
  { 0x7f, 0x08, 0x14, 0x22, 0x41 },  // K 0x4b 75
  { 0x7f, 0x40, 0x40, 0x40, 0x40 },  // L 0x4c 76
  { 0x7f, 0x02, 0x0c, 0x02, 0x7f },  // M 0x4d 77
  { 0x7f, 0x04, 0x08, 0x10, 0x7f },  // N 0x4e 78
  { 0x3e, 0x41, 0x41, 0x41, 0x3e },  // O 0x4f 79
  { 0x7f, 0x09, 0x09, 0x09, 0x06 },  // P 0x50 80
  { 0x3e, 0x41, 0x51, 0x21, 0x5e },  // Q 0x51 81
  { 0x7f, 0x09, 0x19, 0x29, 0x46 },  // R 0x52 82
  { 0x46, 0x49, 0x49, 0x49, 0x31 },  // S 0x53 83
  { 0x01, 0x01, 0x7f, 0x01, 0x01 },  // T 0x54 84
  { 0x3f, 0x40, 0x40, 0x40, 0x3f },  // U 0x55 85
  { 0x0f, 0x30, 0x40, 0x30, 0x0f },  // V 0x56 86
  { 0x3f, 0x40, 0x30, 0x40, 0x3f },  // W 0x57 87
  { 0x63, 0x14, 0x08, 0x14, 0x63 },  // X 0x58 88
  { 0x07, 0x08, 0x70, 0x08, 0x07 },  // Y 0x59 89
  { 0x61, 0x51, 0x49, 0x45, 0x43 },  // Z 0x5a 90
  { 0x3c, 0x4a, 0x49, 0x29, 0x1e },  // [ 0x5b 91
  { 0x02, 0x04, 0x08, 0x10, 0x20 },  // \ 0x5c 92
  { 0x00, 0x41, 0x7f, 0x00, 0x00 },  // ] 0x5d 93
  { 0x04, 0x02, 0x01, 0x02, 0x04 },  // ^ 0x5e 94
  { 0x40, 0x40, 0x40, 0x40, 0x40 },  // _ 0x5f 95
  { 0x00, 0x00, 0x03, 0x04, 0x00 },  // ` 0x60 96
  { 0x20, 0x54, 0x54, 0x54, 0x78 },  // a 0x61 97
  { 0x7f, 0x48, 0x44, 0x44, 0x38 },  // b 0x62 98
  { 0x38, 0x44, 0x44, 0x44, 0x20 },  // c 0x63 99
  { 0x38, 0x44, 0x44, 0x48, 0x7f },  // d 0x64 100
  { 0x38, 0x54, 0x54, 0x54, 0x18 },  // e 0x65 101
  { 0x08, 0x7e, 0x09, 0x01, 0x02 },  // f 0x66 102
  { 0x0c, 0x52, 0x52, 0x52, 0x3e },  // g 0x67 103
  { 0x7f, 0x08, 0x04, 0x04, 0x78 },  // h 0x68 104
  { 0x00, 0x44, 0x7d, 0x40, 0x00 },  // i 0x69 105
  { 0x20, 0x40, 0x44, 0x3d, 0x00 },  // j 0x6a 106
  { 0x00, 0x7f, 0x10, 0x28, 0x44 },  // k 0x6b 107
  { 0x00, 0x41, 0x7f, 0x40, 0x00 },  // l 0x6c 108
  { 0x7c, 0x04, 0x18, 0x04, 0x78 },  // m 0x6d 109
  { 0x7c, 0x08, 0x04, 0x04, 0x78 },  // n 0x6e 110
  { 0x38, 0x44, 0x44, 0x44, 0x38 },  // o 0x6f 111
  { 0x7c, 0x14, 0x14, 0x14, 0x08 },  // p 0x70 112
  { 0x08, 0x14, 0x14, 0x18, 0x7c },  // q 0x71 113
  { 0x7c, 0x08, 0x04, 0x04, 0x08 },  // r 0x72 114
  { 0x48, 0x54, 0x54, 0x54, 0x20 },  // s 0x73 115
  { 0x04, 0x3f, 0x44, 0x40, 0x20 },  // t 0x74 116
  { 0x3c, 0x40, 0x40, 0x20, 0x7c },  // u 0x75 117
  { 0x1c, 0x20, 0x40, 0x20, 0x1c },  // v 0x76 118
  { 0x3c, 0x40, 0x30, 0x40, 0x3c },  // w 0x77 119
  { 0x44, 0x28, 0x10, 0x28, 0x44 },  // x 0x78 120
  { 0x0c, 0x50, 0x50, 0x50, 0x3c },  // y 0x79 121
  { 0x44, 0x64, 0x54, 0x4c, 0x44 },  // z 0x7a 122
  { 0x00, 0x08, 0x36, 0x41, 0x41 },  // { 0x7b 123
  { 0x00, 0x00, 0x7f, 0x00, 0x00 },  // | 0x7c 124
  { 0x41, 0x41, 0x36, 0x08, 0x00 },  // } 0x7d 125
  { 0x04, 0x02, 0x04, 0x08, 0x04 },  // ~ 0x7e 126

  { 0x7E, 0x11, 0x11, 0x11, 0x7E },  //__–ê (0xC0).
  { 0x7F, 0x49, 0x49, 0x49, 0x33 },  //__–ë (0xC1).
  { 0x7F, 0x49, 0x49, 0x49, 0x36 },  //__–í (0xC2).
  { 0x7F, 0x01, 0x01, 0x01, 0x03 },  //__–ì (0xC3).
  { 0xE0, 0x51, 0x4F, 0x41, 0xFF },  //__–î (0xC4).
  { 0x7F, 0x49, 0x49, 0x49, 0x41 },  //__–ï (0xC5).
  { 0x77, 0x08, 0x7F, 0x08, 0x77 },  //__–ñ (0xC6).
  { 0x41, 0x49, 0x49, 0x49, 0x36 },  //__–ó (0xC7).
  { 0x7F, 0x10, 0x08, 0x04, 0x7F },  //__–ò (0xC8).
  { 0x7C, 0x21, 0x12, 0x09, 0x7C },  //__–ô (0xC9).
  { 0x7F, 0x08, 0x14, 0x22, 0x41 },  //__–ö (0xCA).
  { 0x20, 0x41, 0x3F, 0x01, 0x7F },  //__–õ (0xCB).
  { 0x7F, 0x02, 0x0C, 0x02, 0x7F },  //__–ú (0xCC).
  { 0x7F, 0x08, 0x08, 0x08, 0x7F },  //__–ù (0xCD).
  { 0x3E, 0x41, 0x41, 0x41, 0x3E },  //__–û (0xCE).
  { 0x7F, 0x01, 0x01, 0x01, 0x7F },  //__–ü (0xCF).
  { 0x7F, 0x09, 0x09, 0x09, 0x06 },  //__–† (0xD0).
  { 0x3E, 0x41, 0x41, 0x41, 0x22 },  //__–° (0xD1).
  { 0x01, 0x01, 0x7F, 0x01, 0x01 },  //__–¢ (0xD2).
  { 0x47, 0x28, 0x10, 0x08, 0x07 },  //__–£ (0xD3).
  { 0x1C, 0x22, 0x7F, 0x22, 0x1C },  //__–§ (0xD4).
  { 0x63, 0x14, 0x08, 0x14, 0x63 },  //__–• (0xD5).
  { 0x7F, 0x40, 0x40, 0x40, 0xFF },  //__–¶ (0xD6).
  { 0x07, 0x08, 0x08, 0x08, 0x7F },  //__–ß (0xD7).
  { 0x7F, 0x40, 0x7F, 0x40, 0x7F },  //__–® (0xD8).
  { 0x7F, 0x40, 0x7F, 0x40, 0xFF },  //__–© (0xD9).
  { 0x01, 0x7F, 0x48, 0x48, 0x30 },  //__–™ (0xDA).
  { 0x7F, 0x48, 0x30, 0x00, 0x7F },  //__–´ (0xDB).
  { 0x00, 0x7F, 0x48, 0x48, 0x30 },  //__–¨ (0xDC).
  { 0x22, 0x41, 0x49, 0x49, 0x3E },  //__–≠ (0xDD).
  { 0x7F, 0x08, 0x3E, 0x41, 0x3E },  //__–Æ (0xDE).
  { 0x46, 0x29, 0x19, 0x09, 0x7F },  //__–Ø (0xDF).

  { 0x20, 0x54, 0x54, 0x54, 0x78 },  //__–∞ (0xE0).
  { 0x3C, 0x4A, 0x4A, 0x49, 0x31 },  //__–± (0xE1).
  { 0x7C, 0x54, 0x54, 0x28, 0x00 },  //__–≤ (0xE2).
  { 0x7C, 0x04, 0x04, 0x0C, 0x00 },  //__–≥ (0xE3).
  { 0xE0, 0x54, 0x4C, 0x44, 0xFC },  //__–¥ (0xE4).
  { 0x38, 0x54, 0x54, 0x54, 0x18 },  //__–µ (0xE5).
  { 0x6C, 0x10, 0x7C, 0x10, 0x6C },  //__–∂ (0xE6).
  { 0x44, 0x54, 0x54, 0x28, 0x00 },  //__–∑ (0xE7).
  { 0x7C, 0x20, 0x10, 0x08, 0x7C },  //__–∏ (0xE8).
  { 0x78, 0x42, 0x24, 0x12, 0x78 },  //__–π (0xE9).
  { 0x7C, 0x10, 0x28, 0x44, 0x00 },  //__–∫ (0xEA).
  { 0x20, 0x44, 0x3C, 0x04, 0x7C },  //__–ª (0xEB).
  { 0x7C, 0x08, 0x10, 0x08, 0x7C },  //__–º (0xEC).
  { 0x7C, 0x10, 0x10, 0x10, 0x7C },  //__–Ω (0xED).
  { 0x38, 0x44, 0x44, 0x44, 0x38 },  //__–æ (0xEE).
  { 0x7C, 0x04, 0x04, 0x04, 0x7C },  //__–ø (0xEF).
  { 0x7C, 0x14, 0x14, 0x14, 0x08 },  //__—Ä (0xF0).
  { 0x38, 0x44, 0x44, 0x44, 0x00 },  //__—Å (0xF1).
  { 0x04, 0x04, 0x7C, 0x04, 0x04 },  //__—Ç (0xF2).
  { 0x0C, 0x50, 0x50, 0x50, 0x3C },  //__—É (0xF3).
  { 0x30, 0x48, 0xFE, 0x48, 0x30 },  //__—Ñ (0xF4).
  { 0x44, 0x28, 0x10, 0x28, 0x44 },  //__—Ö (0xF5).
  { 0x7C, 0x40, 0x40, 0x7C, 0xC0 },  //__—Ü (0xF6).
  { 0x0C, 0x10, 0x10, 0x10, 0x7C },  //__—á (0xF7).
  { 0x7C, 0x40, 0x7C, 0x40, 0x7C },  //__—à (0xF8).
  { 0x7C, 0x40, 0x7C, 0x40, 0xFC },  //__—â (0xF9).
  { 0x04, 0x7C, 0x50, 0x50, 0x20 },  //__—ä (0xFA).
  { 0x7C, 0x50, 0x50, 0x20, 0x7C },  //__—ã (0xFB).
  { 0x7C, 0x50, 0x50, 0x20, 0x00 },  //__—å (0xFC).
  { 0x28, 0x44, 0x54, 0x54, 0x38 },  //__—ç (0xFD).
  { 0x7C, 0x10, 0x38, 0x44, 0x38 },  //__—é (0xFE).
  { 0x08, 0x54, 0x34, 0x14, 0x7C },  //__—è (0xFF).
};

#include "RunXY.h"

WiFiClient espClient;
PubSubClient mqtt(espClient);
GestureXY g;
RunXY run;
Button btn(4);

DB_KEYS(
  kk,
  ssid,
  pass,
  ssid1,
  pass1,
  host,
  port,
  local,
  remote,
  header,
  serial,
  brightness,
  state,
  stateGest,
  tempGest,
  plusBrightnessGest,
  plusBrightness,
  minusBrightnessGest,
  nextGest,
  previousGest,
  offScenes,
  onScenes,
  workScenes,
  chillScenes,
  sep);
;

GyverDBFile db(&LittleFS, "üî¶ LampXY.db");
SettingsGyver sett((String) "üèÆ LampXY", &db);

struct gestureData {
  byte scene = 0;
  String scenes[4] = { "–¶–≤–µ—Ç–Ω–æ–π", "–•–æ–ª–æ–¥–Ω—ã–π", "–ù–æ—Ä–º–∞–ª—å–Ω—ã–π", "–¢—ë–ø–ª—ã–π" };
  byte colors[8][3]{
    { 255, 0, 0 },
    { 255, 110, 0 },
    { 255, 255, 0 },
    { 0, 255, 0 },
    { 0, 255, 110 },
    { 0, 0, 255 },
    { 255, 0, 110 },
    { 255, 0, 255 }
  };
  byte color = 6;
} gData;

#define PIN 13
#define TYPE WS2812
#define ORDER GRB
#define GND 15

CRGB leds[NUM];

void setup() {
  db_init();
  pinMode(GND, OUTPUT);
  digitalWrite(GND, LOW);
  Serial.begin(db[kk::serial]);
  Serial.setTimeout(50);
  FastLED.addLeds<TYPE, PIN, ORDER>(leds, NUM);
  FastLED.setMaxPowerInVoltsAndMilliamps(5, 800);
  FastLED.setBrightness(db[kk::brightness]);
  for (byte i = 0; i < NUM; i++) {
    leds[i].setRGB(0, 0, 0);
  }
  delay(100);
  FastLED.show();
  run.setColor(CRGB(gData.colors[gData.color][0], gData.colors[gData.color][1], gData.colors[gData.color][2]));
  bool flag = false;
  uint32_t timer = 0;
  WiFi.begin(db[kk::ssid], db[kk::pass]);
  String runningText = "1";
  while (WiFi.status() != WL_CONNECTED) {
    if (btn.read()) timer = 15000;
    delay(500);
    if (run.fullTextFlag) run.loadingFlag = true;
    run.fill(leds, runningText);
    Serial.print(".");
    timer += 500;
    if (timer > 15000) {
      timer = 0;
      if (!flag) {
        Serial.println("—Ä–µ–°–µ—Ç—å");
        WiFi.disconnect();
        WiFi.begin(db[kk::ssid1], db[kk::pass1]);
        runningText = "2";
        flag = true;
      } else {
        ESP.restart();
      }
    }
  }
  Serial.println("–ü–æ–¥–∫–ª—é—á–∏–ª—Å—è");
  Serial.println(WiFi.localIP());
  for (int i = 0; i < NUM; i++) leds[i].setRGB(0, 0, 0);
  FastLED.show();
  sett.begin();
  sett.config.theme = sets::Colors::Green;
  sett.onBuild(build);
  mqtt.setServer(db[kk::host].c_str(), db[kk::port]);
  mqtt.setCallback(callback);
  mqtt.setSocketTimeout(1000);
  connectMQTT();
  do run.fill(leds, String(WiFi.localIP()));
  while (!run.fullTextFlag);
}

void loop() {
  mqttTick();
  sett.tick();
  btnTick();
}

void light() {
  FastLED.setBrightness(db[kk::brightness]);
  for (int i = 0; i < NUM; i++) {
    if (db[kk::state]) {
      switch (gData.scene) {
        case 0:
          leds[i].setRGB(gData.colors[gData.color][0], gData.colors[gData.color][1], gData.colors[gData.color][2]);
          break;
        case 1:
          leds[i].setRGB(0, 213, 255);
          break;
        case 2:
          leds[i].setRGB(255, 255, 255);
          break;
        case 3:
          leds[i].setRGB(255, 200, 0);
          break;
      }
    } else {
      leds[i].setRGB(0, 0, 0);
    }
  }
  FastLED.show();
}

void btnTick() {
  btn.tick();
  if (btn.hasClicks(1)) db[kk::state] = !db[kk::state];
  else if (btn.hasClicks(2)) db[kk::brightness] += (byte)db[kk::plusBrightness];
  else if (btn.hasClicks(3)) db[kk::brightness] -= (byte)db[kk::plusBrightness];
  else if (btn.hold(2)) gData.scene = ++gData.scene % 4;
  else if (btn.hold(3)) gData.color = ++gData.color % 8;
  else if (btn.hold()) ESP.restart();
  else return;
  light();
}
